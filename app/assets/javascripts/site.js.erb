$(document).ready(function() {
  $(".site.map").ready(function() {

    var keyPressed,
        ash = $('#ash');

    var $gameScreen = $('.game-screen'),
        $gameTile = $('.game-tile'),
        $gameMap = $('#game-map');

    var mapArray,
        map1 = [
          ['o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1'],
          ['o1',    0, 'o1',    0,    0,    0,    0,    0, 'o1',    0,    0, 'o1'],
          ['o1',    0, 'o2',    0, 'o3', 'o3', 'o1',    0, 'o2', 'o2',    0, 'o1'],
          ['o1',    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 'o1'],
          ['o1',    0,    0, 'o1',    0, 'o3',    0,    0, 'o1',    0,    0, 'o1'],
          ['o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1']
        ],
        ashUrl = '<img src="/assets/ash/ash.png" id="ash">',
        ashPos = { row: 4, col: 10 },
        columnHeight;

    // Sets the height of a tile to be the same as the width
    // to make each one a square
    function setSizeMap() {
      columnHeight = Math.floor($gameMap.width() / 12);
      var marginLeft = ($gameScreen.width() - $gameMap.width()) / 2;
      $gameTile.height(columnHeight);
      $gameTile.width(columnHeight);
      console.log(marginLeft);
      $gameMap.css('margin-left', marginLeft);
    }
    setSizeMap();
    $(window).on("resize", setSizeMap);


    // Generates jquery selector for the given row and column
    function generateSelector(row, col) {
      selector = '#r' + row + 'c' + col;
      return selector;
    }

    // Place objects and characters on the map.
    // Place given obstacle at the given row and column
    function placeObstacle(obstacle, row, col) {
      selector = generateSelector(row, col);
      $(selector).addClass(obstacle);
      $(selector).addClass('obstacle');
    }

    function placeAsh(row, col) {
      selector = generateSelector(row, col);
      $(selector).html(ashUrl);
    }

    // Place given number of pokemon on the map
    function placePokemon(number) {
      var pokemonId,
          checkTile,
          row,
          col,
          imageUrlToAppend;
      for(i=0; i<number; i++) {
        pokemonId = 1 + Math.floor(151*Math.random());
        checkTile = true;
        while (checkTile) {
          row = 1 + Math.floor(4*Math.random());
          col = 1 + Math.floor(10*Math.random());
          selector = generateSelector(row, col);
          if (mapArray[row][col] === 0 && (row !== ashPos.row && col !== ashPos.col)) {
            checkTile = false;
            $(selector).addClass('pokemon');
            imageUrlToAppend = '<img src="/assets/pokemon/' + pokemonId + '.png" class="img-responsive">';
            $(selector).html(imageUrlToAppend);
            mapArray[row][col] = pokemonId;
          }
        }
      }
      console.log(mapArray);
    }

    function setMap() {
      mapArray = map1;
      placeAsh(ashPos.row, ashPos.col);
      for(i=0;i<6;i++) {
        for(j=0;j<12;j++) {
          if(mapArray[i][j][0] === 'o') {
            placeObstacle(mapArray[i][j], i, j);
          }
        }
      }
      // if (savedstate) {
      //   restoresavedstate
      //   placePokemon(1)
      // } else {
      placePokemon(5);
      // }
    }
    setMap();

    function moveLeft(position, selector) {
      selector.animate({ left: ('-='+columnHeight) });
      position.col -= 1;
    }

    function moveUp(position, selector) {
      selector.animate({ top: ('-='+columnHeight) });
      position.row -= 1;
    }

    function moveRight(position, selector) {
      selector.animate({ left: ('+='+columnHeight) });
      position.col += 1;
    }

    function moveDown(position, selector) {
      selector.animate({ top: ('+='+columnHeight) });
      position.row += 1;
    }    

    function checkLeft(position) {
      return mapArray[position.row][position.col - 1];
    }

    function checkUp(position) {
      return mapArray[position.row - 1][position.col];
    }

    function checkRight(position) {
      return mapArray[position.row][position.col + 1];
    }

    function checkDown(position) {
      return mapArray[position.row + 1][position.col];
    }

    var key = {
      '106': { 
        position: checkLeft, 
        direction: moveLeft
      },
      '105': { 
        position: checkUp,
        direction: moveUp
      },
      '108': { 
        position: checkRight,
        direction: moveRight
      },
      '107': { 
        position: checkDown,
        direction: moveDown
      }
    }

    $(document).on('keypress', function(event) {
      keyPressed = event.which.toString();
      console.log(key[keyPressed].position(ashPos) === 0)
      if (key[keyPressed].position(ashPos) === 0) {
        // moveLeft, moveUp, etc.
        key[keyPressed].direction(ashPos, $('#ash'))
      } else if (typeof key[keyPressed].position(ashPos) === 'number') {
        url = 'pokemons/' + key[keyPressed].position(ashPos)
        // key[keyPressed].position(ashPos) = 0; // remove pokemon from the map
        $(document).off('keypress');
        window.location.href = baseUrl + url; 
      }
    });
  });

  //now needs to pass through some kind of request and be able to access through the controller 
  // $.ajax({
  //   type: "post",
  //   url: "/mapstate",
  //   // grabbing the map array and turning it into string
  //   data: {data_value: JSON.stringify(mapArray)}
  // });
  
});