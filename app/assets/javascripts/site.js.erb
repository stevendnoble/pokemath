$(document).ready(function() {
  $(".site.map").ready(function() {

    var keyPressed;

    var $gameScreen = $('.game-screen'),
        $gameTile = $('.game-tile'),
        $gameMap = $('#game-map');

    var mapArray,
        map1 = [
          ['o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1'],
          ['o1',    0, 'o1',    0,    0,    0,    0,    0, 'o1',    0,    0, 'o1'],
          ['o1',    0, 'o2',    0, 'o3', 'o3', 'o1',    0, 'o2', 'o2',    0, 'o1'],
          ['o1',    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, 'o1'],
          ['o1',    0,    0, 'o1',    0, 'o3',    0,    0, 'o1',    0,    0, 'o1'],
          ['o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1', 'o1']
        ],
        ashUrl = '<img src="/assets/ash/ash.png" id="ash">',
        ashPos = { row: 4, col: 10 },
        columnHeight;

    // Sets the height of a tile to be the same as the width
    // to make each one a square
    function setSizeMap() {
      columnHeight = Math.floor($gameMap.width() / 12);
      var marginLeft = ($gameScreen.width() - $gameMap.width()) / 2;
      $gameTile.height(columnHeight);
      $gameTile.width(columnHeight);
      $gameMap.css('margin-left', marginLeft);
    }
    setSizeMap();
    $(window).on("resize", setSizeMap);

    // Generates jquery selector for the given row and column
    function generateSelector(row, col) {
      selector = '#r' + row + 'c' + col;
      return selector;
    }

    // Place objects and characters on the map.
    // Place given obstacle at the given row and column
    function placeObstacle(obstacle, row, col) {
      selector = generateSelector(row, col);
      $(selector).addClass(obstacle);
      $(selector).addClass('obstacle');
    }

    function placeAsh(row, col) {
      selector = generateSelector(row, col);
      $(selector).html(ashUrl);
    }

    // Place given number of pokemon on the map
    function placePokemon(number) {
      var pokemonId,
          checkTile,
          row,
          col,
          imageUrlToAppend;
      for(i=0; i<number; i++) {
        pokemonId = 1 + Math.floor(151*Math.random());
        checkTile = true;
        while (checkTile) {
          row = 1 + Math.floor(4*Math.random());
          col = 1 + Math.floor(10*Math.random());
          selector = generateSelector(row, col);
          if (mapArray[row][col] === 0 && (row !== ashPos.row && col !== ashPos.col)) {
            checkTile = false;
            $(selector).addClass('pokemon');
            imageUrlToAppend = '<img src="/assets/pokemon/' + pokemonId + '.png" class="img-responsive">';
            $(selector).html(imageUrlToAppend);
            mapArray[row][col] = pokemonId;
          }
        }
      }
      console.log(mapArray);
    }

    function setMap() {
      var imageUrlToAppend;
      console.log(ashPos)
      placeAsh(ashPos.row, ashPos.col);
      for(i=0;i<6;i++) {
        for(j=0;j<12;j++) {
          if(mapArray[i][j][0] === 'o') {
            placeObstacle(mapArray[i][j], i, j);
          }else if (typeof mapArray[i][j] === 'number' && mapArray[i][j] > 0) {
            selector = generateSelector(i, j);
            $(selector).addClass('pokemon');
            imageUrlToAppend = '<img src="/assets/pokemon/' + mapArray[i][j] + '.png" class="img-responsive">';
            $(selector).html(imageUrlToAppend);
          }
        }
      }
    }
    // setMap();

    function moveLeft(position, selector) {
      selector.animate({ left: ('-='+columnHeight) });
      position.col -= 1;
    }

    function moveUp(position, selector) {
      selector.animate({ top: ('-='+columnHeight) });
      position.row -= 1;
    }

    function moveRight(position, selector) {
      selector.animate({ left: ('+='+columnHeight) });
      position.col += 1;
    }

    function moveDown(position, selector) {
      selector.animate({ top: ('+='+columnHeight) });
      position.row += 1;
    }    

    function checkLeft(position) {
      return mapArray[position.row][position.col - 1];
    }

    function checkUp(position) {
      return mapArray[position.row - 1][position.col];
    }

    function checkRight(position) {
      return mapArray[position.row][position.col + 1];
    }

    function checkDown(position) {
      return mapArray[position.row + 1][position.col];
    }

    function removeLeft(position) {
      mapArray[position.row][position.col - 1] = 0;
    }

    function removeUp(position) {
      mapArray[position.row - 1][position.col] = 0;
    }

    function removeRight(position) {
      mapArray[position.row][position.col + 1] = 0;
    }

    function removeDown(position) {
      mapArray[position.row + 1][position.col] = 0;
    }


    var key = {
      '106': { 
        position: checkLeft, 
        direction: moveLeft,
        remove: removeLeft
      },
      '105': { 
        position: checkUp,
        direction: moveUp,
        remove: removeUp
      },
      '108': { 
        position: checkRight,
        direction: moveRight,
        remove: removeRight
      },
      '107': { 
        position: checkDown,
        direction: moveDown,
        remove: removeDown
      }
    }

    $(document).on('keypress', function(event) {
      keyPressed = event.which.toString();
      console.log(key[keyPressed].position(ashPos) === 0)
      if (key[keyPressed].position(ashPos) === 0) {
        // moveLeft, moveUp, etc.
        key[keyPressed].direction(ashPos, $('#ash'))
      } else if (typeof key[keyPressed].position(ashPos) === 'number') {
        url = baseUrl + 'pokemons/' + key[keyPressed].position(ashPos)
        key[keyPressed].remove(ashPos); // remove pokemon from the map
        console.log(mapArray);
        $(document).off('keypress');
        saveState(url);
      }
    });

    //now needs to pass through some kind of request and be able to access through the controller 
    function saveState(url) {
      var state = {mapArray: mapArray, ashPos: ashPos};
      $.ajax({
        type: "post",
        url: "/mapstate",
        data: {data_value: JSON.stringify(state) },
        success: function() {
          window.location.href = url; 
        }
      });
    };

    function loadState() {
      $.ajax({
        type: "get",
        url: "/mapstate",
        success: function(data) {
          console.log(data);
          if (data.initialize_map) {
            mapArray = map1;
            setMap();
            placePokemon(5);
          } else {
            mapArray = data.map_state.mapArray;
            ashPos = data.map_state.ashPos;
            setMap();
            placePokemon(1);
          }
        } 
      });
    }
  
    loadState();
  });
});